---
layout: page
title: "Express (NodeJS)"
top_title: "部署 Express 应用"
category: tutorial
date: 2015-02-28 20:19
order: 7
published: true
---
### Express 简介
Express 是一个简洁而灵活的 node.js Web应用框架，关于它的详细介绍及安装和使用方法请参考 [Express.js官网] 。  

### 部署方法
目前 CNPaaS 的部署方法主要针对 [Express 3.x](http://www.expressjs.com.cn/3x/api.html) 的版本，请留意文档的后续更新
#### 1.准备项目
首先你需要在 CNPaaS 后台[创建]一个 Node.js 应用：

<img class="embeddable" src="{{site.url}}/images/express/express1.jpg" alt="Express" title="Express" />

我们可以点击进去应用详情，点击应用的**温馨提示**可以查看快速部署的提示。

首先在终端里用 **git clone** 这个应用的 **Git 地址** 的方法获得初始项目：

{% highlight console %} 
$ git clone <git-url> 
{% endhighlight %}

然后将 Express 应用目录里的所有文件复制到 `git clone` 下来的初始项目的目录里。

#### 2. 修改程序
为了让我们的 Express 应用能顺利在 CNPaaS 运行，我们需要对程序作出一些必要的修改。

创建 Express 应用后，我们以“hello world”为例，主程序文件（比如 app.js）的内容是为：    
{% highlight javascript %} 
var express = require('express');
var app = express();

app.get('/', function(req, res){
  res.send('hello world');
});

app.listen(3000);
{% endhighlight %}

这样程序将以端口3000运行，通常可以通过浏览器打开 http://localhost:3000 进行访问。

在 CNPaaS 平台上，需要将端口和IP地址根据 [Openshift的环境变量] 进行定义，在程序里加入：  
{% highlight javascript %} 
var server_port = process.env.OPENSHIFT_NODEJS_PORT || 8080;
var server_ip_address = process.env.OPENSHIFT_NODEJS_IP || '127.0.0.1';
{% endhighlight %}

在 CNPaaS 的运行环境里，Express 应用通常会用到这两个环境变量：

* **`OPENSHIFT_NODEJS_PORT`** : Node.js应用端口。
* **`OPENSHIFT_NODEJS_IP`** : Node.js应用IP地址。  

在 Node.js 类型的应用里，我们可以通过 **`process.env.环境变量名`** 的形式来调用该环境变量。


**`app.listen`** 的形式为：  
{% highlight javascript %} 
app.listen(server_port, server_ip_address, function () {})
{% endhighlight %}

另外由于 CNPaaS 的运行环境会根据 Express 项目里的 **package.json** 来自动执行 npm install 来安装模块，以及判断如何执行你的程序，所以有两点需要注意：

* 如果你主程序文件是 **app.js** 并以 `node app.js` 执行的话，package.json 里应该有以下代码：  
{% highlight javascript %} 
  "scripts": {
    "start": "node app.js"
  },
  "main": "app.js",
{% endhighlight %}  

* 在 **.gitignore** 文件里加入这一句：
{% highlight console %} 
node_modules
{% endhighlight %} 
以避免本地安装的模块和 CNPaaS 的运行环境不兼容。


#### 3. MongoDB
在 CNPaaS 的应用后台的**外挂服务**里可以一键创建 MongoDB 数据库：

<img class="embeddable" src="{{site.url}}/images/mongodb/mongodb1.jpg" alt="MongoDB" title="MongoDB" />

创建后点击可查看该数据库的详细信息，包括环境变量和对应的值：

<img class="embeddable" src="{{site.url}}/images/mongodb/mongodb2.jpg" alt="MongoDB" title="MongoDB" />

我们可以数据库信息配置我们的程序来让它在 CNPaaS 上运行。

#### 4. 推送代码
修改完项目之后，依次执行以下命令：
{% highlight console %} 
$ git add -A .
$ git commit -m "commit信息"
$ git push origin master
{% endhighlight %}
即可把项目部署到 CNPaaS。

对于Git的详细使用，建议参考以下资料：[Pro Git]

#### 5. 访问应用
打开 CNPaaS后台 该应用的详情页面，里面有 **CNPaaS 网址** 一项，点击该网址，即可访问你的应用。

#### 6. 设定独立域名
如果想为你的 HTML 网站设定独立的域名进行访问，可参考 [自定义网址]({{site.url}}/usage/custom-domains.html) 。

### 实例解析

我们可以用一些实力进行测试，比如 Github上这个：  
[express3-mongodb-bootstrap-demo](https://github.com/hiattp/express3-mongodb-bootstrap-demo)

把该项目clone下来后并根据其 [Install and Run](https://github.com/hiattp/express3-mongodb-bootstrap-demo#install-and-run) 提示创建config.js之后，我们需要修改 **app.js** 文件，让它按照上述提到的方法在 CNPaaS 上运行：

<ul>
<li>去掉或者注释掉这行:
{% highlight javascript %} 
app.set('port', process.env.PORT || 3000);
{% endhighlight %} 
</li>
<li>把 改成这样子：
{% highlight javascript %} 
var generateMongoUrl = function(){

  var connection_string = process.env.OPENSHIFT_MONGODB_DB_HOST + '/' + process.env.OPENSHIFT_APP_NAME;
  if(process.env.OPENSHIFT_MONGODB_DB_PASSWORD){
    connection_string = process.env.OPENSHIFT_MONGODB_DB_USERNAME + ":" +    process.env.OPENSHIFT_MONGODB_DB_PASSWORD + "@" +
    process.env.OPENSHIFT_MONGODB_DB_HOST + ':' +
    process.env.OPENSHIFT_MONGODB_DB_PORT + '/' +
    process.env.OPENSHIFT_APP_NAME;
  }
  return connection_string;
}
  mongoose.connect(generateMongoUrl());
{% endhighlight %} 
</li>
<li>
定义 CNPaaS 以 <b>npm start</b> 的方式运行该应用，在项目目录里执行：    
{% highlight console %} 
mkdir -p .openshift/markers && touch .openshift/markers/use_npm
{% endhighlight %} 
</li>
</ul>

接下来依次执行以下命令把该项目部署到 CNPaaS 上：
{% highlight console %} 
$ git add -A .
$ git commit -m "commit信息"
$ git remote add cnpaas <git-url>
{% endhighlight %} 
*<git-url>为 CNPaaS 后台创建 Node.js 应用后获得的 Git 地址*
{% highlight console %} 
$ git push -f cnpaas master
{% endhighlight %} 
请参考应用后台里 **Git 地址** 栏目 **温馨提示** 的 **现有项目** 部分。

`git push` 成功之后可以在终端看到相应信息：
<img class="embeddable" src="{{site.url}}/images/express/express2.jpg" alt="Express" title="Express" />

最后打开 CNPaaS 后台应用详情页里的 **CNPaaS 网址** 测试一下：
<img class="embeddable" src="{{site.url}}/images/express/express3.jpg" alt="Express" title="Express" />


[Express.js官网]:http://expressjs.com/zh/
[Openshift的环境变量]:https://developers.openshift.com/en/managing-environment-variables.html
[创建]:http://dashboard.cnpaas.io/a
[Pro Git]:http://git-scm.com/book/zh/