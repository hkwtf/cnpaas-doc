---
layout: page
title: "Symfony (PHP)"
top_title: "部署 Symfony 应用"
category: tutorial
date: 2015-02-28 20:19
order: 4
published: true
---
### Symfony 简介
Symfony是一个基于MVC模式的面向对象的PHP5框架。Symfony允许在一个web应用中分离事务控制，服务逻辑和表示层。  
详细介绍可访问 [Symfony官网] ，并阅读 [官方文档](http://symfony.com/doc/current/index.html) 或通过 [The Quick Tour] 了解如何安装 Symfony 以及用使用 Symfony框架 开发应用。

### 部署方法
我们接下来将以 [The Quick Tour] 里的示例所创建的初始应用为例子，介绍如何在 CNPaaS 部署 Symfony 应用。

#### 1.创建应用

登陆 CNPaaS 后台，[创建]一个 “**PHP 5.4**” 应用：

<img class="embeddable" src="{{site.url}}/images/static/static1.jpg" alt="创建PHP应用" title="创建PHP应用" />

然后点击该应用，在应用详情页面的“**外挂服务**”里，点击“新增数据库”里的“**MySQL 5.5**”按钮，即可创建 WordPress 所需的数据库。

#### 2.准备代码
安装好 Symfony 之后，我们可以用 `symfony` 命令来创建项目，

Linux 或者 Mac OS X 下执行：
{% highlight console %}
$ symfony new myproject
{% endhighlight %}

Windows 下执行：
{% highlight console %}
c:\> php symfony.phar new myproject
{% endhighlight %}

创建成功之后，进入 `myproject` 目录，创建 **`.openshift`** 目录并在 `.openshift` 里创建 **`action_hooks`** 目录：
{% highlight console %}
mkdir -p .openshift/action_hooks
{% endhighlight %}

进入 `action_hooks` 目录后创建一个名为 **`deploy`** 的文件，内容为：

{% highlight console %}
#!/bin/bash

export COMPOSER_HOME="$OPENSHIFT_DATA_DIR/.composer"

if [ ! -f "$OPENSHIFT_DATA_DIR/composer.phar" ]; then
    curl -s https://getcomposer.org/installer | /usr/bin/php -- --install-dir=$OPENSHIFT_DATA_DIR
else
    /usr/bin/php $OPENSHIFT_DATA_DIR/composer.phar self-update
fi

unset GIT_DIR
cd $OPENSHIFT_REPO_DIR
/usr/bin/php $OPENSHIFT_DATA_DIR/composer.phar install

/usr/bin/php $OPENSHIFT_REPO_DIR/app/console cache:clear --env=dev

chmod -R 0777 $OPENSHIFT_REPO_DIR/app/cache
chmod -R 0777 $OPENSHIFT_REPO_DIR/app/logs
{% endhighlight %}

并且让 `deploy` 文件有可执行权限：
{% highlight console %}
chmod +x deploy
{% endhighlight %}

里边使用了 CNPaaS 的环境变量：

* **`OPENSHIFT_DATA_DIR`** : 持久数据目录。 
* **`OPENSHIFT_REPO_DIR`** : 运行应用的主目录。 

关于更多的环境变量及详细介绍，请阅读 [OpenShift 的官方文档](https://developers.openshift.com/en/managing-environment-variables.html) 。  

在项目的 `app/config/`目录里创建 **`params.php`** 文件。并将 CNPaaS 的数据库环境变量写入：

{% highlight php %}
<?php
$container->setParameter('database_host', getEnv("OPENSHIFT_MYSQL_DB_HOST"));
$container->setParameter('database_port', getEnv("OPENSHIFT_MYSQL_DB_PORT"));
$container->setParameter('database_name', getEnv("OPENSHIFT_APP_NAME"));
$container->setParameter('database_user', getEnv("OPENSHIFT_MYSQL_DB_USERNAME"));
$container->setParameter('database_password', getEnv("OPENSHIFT_MYSQL_DB_PASSWORD"));
?>
{% endhighlight %}

并且要把对 `params.php` 的调用写进该项目的配置文件里，编辑 **`app/config/config.yml`**，在 `imports:` 部分加上这句：
{% highlight yaml %}
- { resource: params.php }
{% endhighlight %}

编辑 **`.gitignore`** 文件，如果里面有以下两条：

* **`/app/config/parameters.yml`**
* **`/web/bundles/`**

请把这两条从 `.gitignore` 删除。

在项目的**根目录**创建一个 **`.htaccess`** 文件，内容如下：
{% highlight yaml %}
RewriteEngine on
RewriteCond %{REQUEST_URI} !web/
RewriteRule (.*) /web/$1 [L]
{% endhighlight %}

然后可以把 `web/app_dev.php` 的第12到18行注释掉：
{% highlight php %}
// if (isset($_SERVER['HTTP_CLIENT_IP'])
//     || isset($_SERVER['HTTP_X_FORWARDED_FOR'])
//     || !(in_array(@$_SERVER['REMOTE_ADDR'], array('127.0.0.1', 'fe80::1', '::1')) || php_sapi_name() === 'cli-server')
// ) {
//     header('HTTP/1.0 403 Forbidden');
//     exit('You are not allowed to access this file. Check '.basename(__FILE__).' for more information.');
// }
{% endhighlight %}

#### 3. 推送代码

最后一步就是把代码推送到我们的代码库上。

你可以依次执行：
{% highlight console %}
$ git init
$ git add -A
$ git commit . -m "Your Commit Message"
$ git remote add cnpaas <git-repo addr>
$ git push -f cnpaas master
{% endhighlight %}
其中 `<git-repo addr>` 替换为 CNPaaS 上应用后台的 **Git地址**。

对于Git的详细使用，建议参考以下资料：[Pro Git]

#### 4. 测试

最终的测试页面可以通过访问：
**`xxx.app.cnpaas.io/app_dev.php`**
其中 **xxx.app.cnpaas.io** 为 **CNPaaS后台** 该应用的详情页面里面 **CNPaaS 网址** 一项的网址。

如果希望直接打开域名直接访问 `app_dev.php` 或者 以 `app_dev.php` 作为主程序文件。可以编辑 **`web/.htaccess`** 文件，把里面关于 `app.php` 的改为 `app_dev.php` 然后再通过 git 命令推送代码到 CNPaaS 。

成功后如图所示：

<img class="embeddable" src="{{site.url}}/images/symfony/symfony-test.jpg" alt="测试symfony应用" title="测试symfony应用" />

#### 5. 设定独立域名
如果想为你的应用设定独立的域名进行访问，可参考 [自定义网址]({{site.url}}/usage/custom-domains.html) 。





[Symfony官网]:http://symfony.com
[The Quick Tour]:http://symfony.com/doc/current/quick_tour
[创建]:http://dashboard.cnpaas.io/a
[Pro Git]:http://git-scm.com/book/zh/